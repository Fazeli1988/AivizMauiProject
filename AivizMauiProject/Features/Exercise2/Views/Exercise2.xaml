

<ContentPage 
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:vm="clr-namespace:AivizMauiProject.Features.Exercise2.ViewModels"
    xmlns:converters="clr-namespace:AivizMauiProject.Common.Converters"
    x:Class="AivizMauiProject.Features.Exercise2.Views.Exercise2"
    Title="Exercise 2" >

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:NullToBoolConverter x:Key="NullToBoolConverter" />
            <converters:SelectedItemColorConverter x:Key="SelectedItemColorConverter" />
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>


        <AbsoluteLayout>

        <!-- Main Grid Content -->
        <Grid AbsoluteLayout.LayoutBounds="0,0,1,1"
              AbsoluteLayout.LayoutFlags="All"
              Padding="10"
              RowSpacing="10"
              BackgroundColor="#EEF5FF"
              RowDefinitions="Auto,*,Auto">

            <!-- Search -->
            <SearchBar Grid.Row="0"
                       Placeholder="Search items..."
                       Text="{Binding SearchText, Mode=TwoWay}"
                       BackgroundColor="AliceBlue"
                       TextColor="Black" />

            <!-- List -->
            <CollectionView Grid.Row="1"
                            x:Name="ItemsCollectionView"
                            ItemsSource="{Binding Items}"
                            SelectionMode="Single"
                            SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                            ItemSizingStrategy="MeasureAllItems">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout x:Name="GridLayout" Orientation="Vertical" Span="2" />

                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Border StrokeThickness="1"
                                Stroke="LightGray"
                                BackgroundColor="{Binding IsSelected, Converter={StaticResource SelectedItemColorConverter}}"
                                StrokeShape="RoundRectangle 10"
                                Margin="8"
                                Padding="10">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer
                                    Command="{Binding Source={RelativeSource AncestorType={x:Type vm:Exercise2ViewModel}}, Path=ItemTappedCommand}"
                                    CommandParameter="{Binding .}" />
                            </Border.GestureRecognizers>

                            <VerticalStackLayout>
                                <Image Source="{Binding Image}" Aspect="AspectFit" HeightRequest="100" />
                                <Label Text="{Binding Title}" FontAttributes="Bold" FontSize="14" HorizontalOptions="Center" />
                                <Label Text="{Binding Date, StringFormat='{0:yyyy-MM-dd}'}" FontSize="12" HorizontalOptions="Center" />
                            </VerticalStackLayout>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <!-- Bottom Bar -->
            <Border Grid.Row="2"
                    StrokeShape="RoundRectangle 15"
                    BackgroundColor="#176B87"
                    VerticalOptions="End"
                    HorizontalOptions="Center"
                    Padding="10"
                    Margin="37">
                <Border.Shadow>
                    <Shadow Brush="Black" Offset="5,5" Radius="10" Opacity="0.4" />
                </Border.Shadow>

                <HorizontalStackLayout Spacing="20" HorizontalOptions="Center">
                    <!-- Details -->
                    <Button Text="&#xf05a;" FontFamily="FARegular" Command="{Binding OpenDetailsCommand}"
                            IsEnabled="{Binding SelectedItem, Converter={StaticResource NullToBoolConverter}}"
                            FontSize="24" WidthRequest="50" HeightRequest="50" CornerRadius="30"
                            BackgroundColor="Orange" TextColor="White"/>
                    <!-- Edit -->
                    <Button Text="&#xf044;" FontFamily="FARegular" Command="{Binding EditCommand}"
                            IsEnabled="{Binding SelectedItem, Converter={StaticResource NullToBoolConverter}}"
                            FontSize="24" WidthRequest="50" HeightRequest="50" CornerRadius="30"
                            BackgroundColor="DodgerBlue" TextColor="White"/>
                    <!-- Delete -->
                    <Button Text="&#xf1f8;" FontFamily="FARegular" Clicked="OnDeleteClicked"
                            IsEnabled="{Binding SelectedItem, Converter={StaticResource NullToBoolConverter}}"
                            FontSize="24" WidthRequest="50" HeightRequest="50" CornerRadius="30"
                            BackgroundColor="Tomato" TextColor="White"/>
                    <!-- Add -->
                    <Button Text="+" Command="{Binding AddNewCommand}"
                            BackgroundColor="DarkCyan" TextColor="White"
                            FontSize="24" WidthRequest="50" HeightRequest="50" CornerRadius="30"/>
                </HorizontalStackLayout>
            </Border>
        </Grid>

        <!-- Input Blocker Overlay -->
        <Grid IsVisible="{Binding IsPopupVisible}" 
              InputTransparent="False"
              BackgroundColor="#00000000"
              AbsoluteLayout.LayoutBounds="0,0,1,1"
              AbsoluteLayout.LayoutFlags="All"
              ZIndex="5" />

        <!-- Popup Form -->
        <Grid IsVisible="{Binding IsPopupVisible}"
              InputTransparent="False"
              BackgroundColor="#80000000"
              AbsoluteLayout.LayoutBounds="0,0,1,1"
              AbsoluteLayout.LayoutFlags="All"
              ZIndex="10">

            <Border StrokeShape="RoundRectangle 12"
                    BackgroundColor="White"
                    VerticalOptions="Center"
                    HorizontalOptions="Center"
                    WidthRequest="320"
                    Padding="20">
                <VerticalStackLayout Spacing="15">
                    <!-- Filds -->
                    <Entry Placeholder="Title" Text="{Binding CurrentItem.Title}" IsReadOnly="{Binding IsReadOnlyMode}" />
                    <Editor Placeholder="Description"
                            Text="{Binding CurrentItem.Description}"
                            IsReadOnly="{Binding IsReadOnlyMode}"
                            AutoSize="TextChanges"
                            HeightRequest="100"
                            BackgroundColor="White"
                            TextColor="Black"
                            PlaceholderColor="Gray"
                            FontSize="14"
                            Margin="0" />

                    <DatePicker Date="{Binding CurrentItem.Date}" 
                                IsEnabled="{Binding IsReadOnlyMode, Converter={StaticResource InverseBoolConverter}}"
                                HeightRequest="50"
                                WidthRequest="280"
                                HorizontalOptions="Fill"
                                TextColor="Black"
                                BackgroundColor="White" />

                    <Button Text="Select Image"
                            Command="{Binding PickImageCommand}"
                            IsEnabled="{Binding IsReadOnlyMode, Converter={StaticResource InverseBoolConverter}}" />

                    <Image Source="{Binding CurrentItem.Image}" HeightRequest="100" Aspect="AspectFit">
                        <Image.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ImageDoubleTappedCommand}" NumberOfTapsRequired="2" />
                        </Image.GestureRecognizers>
                    </Image>

                    <!-- Show Save/Cancel botton just for Edit and Add  -->
                    <Grid ColumnDefinitions="*,*" IsVisible="{Binding IsReadOnlyMode, Converter={StaticResource InverseBoolConverter}}">
                        <Button Text="Cancel" Command="{Binding CancelCommand}" BackgroundColor="Gray" TextColor="White" Margin="0,10,5,0" />
                        <Button Grid.Column="1" Text="Save" Command="{Binding SaveItemCommand}" BackgroundColor="Green" TextColor="White" Margin="5,10,0,0" />
                    </Grid>

                    <!-- Show Botton Cancel when popup form open for show details -->
                    <Button Text="Close" Command="{Binding CancelCommand}" IsVisible="{Binding IsReadOnlyMode}"
                            BackgroundColor="DodgerBlue" TextColor="White" CornerRadius="10" Margin="0,10,0,0" />
                </VerticalStackLayout>
            </Border>
        </Grid>

        <!--  Image Popup Layer -->
        <Grid IsVisible="{Binding IsImagePopupVisible}"
              InputTransparent="False"
              BackgroundColor="#80000000"
              AbsoluteLayout.LayoutBounds="0,0,1,1"
              AbsoluteLayout.LayoutFlags="All"
              ZIndex="20"
              VerticalOptions="Fill"
              HorizontalOptions="Fill">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CancelImagePopupCommand}" />
            </Grid.GestureRecognizers>

            <Image Source="{Binding PopupImageSource}" VerticalOptions="Center" HorizontalOptions="Center" />
        </Grid>

    </AbsoluteLayout>
</ContentPage>
